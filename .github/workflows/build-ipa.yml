name: Build IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:   # 允许手动触发

jobs:
  build:
    runs-on: macos-14   # 最新的 macOS runner，Xcode 16+

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Ruby & Fastlane
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    - name: Install dependencies
      run: |
        gem install fastlane
        cd ios   # 如果你的 Xcode 项目在 ios 文件夹下，调整路径；如果是根目录就删掉这行

    - name: Import Certificate & Profile
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        # 创建临时目录存放证书
        mkdir -p ~/private_keys

        # 写入 p12 证书
        echo "$APPLE_CERTIFICATE" | base64 --decode > ~/private_keys/AuthKey.p12

        # 写入 mobileprovision
        echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning Profiles/myprofile.mobileprovision

        # 安装证书
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ~/private_keys/AuthKey.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign

        # 设置签名权限
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

    - name: Build IPA with Fastlane
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: |
        fastlane init   # 只跑一次，之后可以注释掉
        cat << EOF > fastlane/Fastfile
        lane :build do
          gym(
            scheme: "YourAppName",   # 替换成你的 Scheme 名称（Xcode 左上角那个）
            export_method: "ad-hoc", # 或 "development"，ad-hoc 可以安装到注册的设备
            output_directory: "./build",
            output_name: "Date114.ipa"
          )
        end
        EOF

        fastlane build

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Date114-ipa
        path: build/Date114.ipa
